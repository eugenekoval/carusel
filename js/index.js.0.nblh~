var ready = false,
    dragging = false,
    pointerStartPosX = 0,
    pointerEndPosX = 0,
    pointerDistance = 0,
    monitorStartTime = 0,
    monitorInt = 10,
    ticker = 0,
    speedMultiplier = 10,
    spinner,
    speed = 1,
    locs,
    img_width = 0,
    img_height = 0,
    is_zoom = false,
         
    totalFrames = 180,
    currentFrame = 0,
    currentScrollTop = 0;
    tempScrollTop = 0;
    scale = 1,
    frames = [],
    interval = 0,
    endFrame = 0,
    language = 'en',
    loadedImages = 0;
    
$(document).ready(function () {
    set_lang();
    set_localization();
    addSpinner();
    loadImage();
    create_buttons();
    
    $("#amount").append(100);
    $("#zoom").slider({
        orientation: "vertical",
        range: "min",
        min: 0,
        max: 2,
        value: 1,
        step: 0.1,
        slide: function(event,ui){
            $("#zoom input").val(ui.value); 
            scale = ui.value;
            $("#index img").css('transform', 'scale('+ui.value+')');    
        }
    });
    $("#zoom input").val(6);
    
    $("#radio").buttonset();
    
    $("#index").mousedown(function (event) {
        var matrix = matrix_obrob($(".current-image").css('transform'));
        if (matrix && matrix > 1){ 
            run_zoom(matrix)
        }
        
        else{        
            delete(dragObj);
            dragObj = false;
            $("#index_images").css('cursor','url(../img_sl/closedhand.cur),default');
            event.preventDefault();
            pointerStartPosX = getPointerEvent(event).pageX;
            dragging = true;
        }
        
        if (interval != 0){
            $("#pause").css('display', 'none');
            $("#left, #right").css('display', 'inline');
            clearInterval(interval);
            interval = 0;
        }
    });
     
    $(document).mouseup(function (event){ 
        $("#index_images").css('cursor','url(../img_sl/openhand.cur),default');
        event.preventDefault();
        dragging = false;
    });
     
    $(document).mousemove(function (event){
        event.preventDefault();
        trackPointer(event);
    });
    
    $("#index").live("touchstart", function (event) {
        event.preventDefault();
        pointerStartPosX = getPointerEvent(event).pageX;
        dragging = true;
        
    });
 
    $("#index").live("touchmove", function (event) {
        event.preventDefault();
        trackPointer(event);
    });
 
    $("#index").live("touchend", function (event) {
        event.preventDefault();
        dragging = false;
    });
     
    $("#left_long").live('click', function(event){
        clearInterval(interval);
        dragging = true;
        trackPointer(event,-10);
        dragging = false;
    });
    
    $("#left").live('click', function(event){
        clearInterval(interval);
        $("#left, #right").css('display', 'none');
        $("#pause").css('display', 'inline');
        interval = window.setInterval(function(){
            dragging = true;
            trackPointer(event,-speed);
            dragging = false;
        }, $("#amount").val());
    });
    $("#right_long").live('click', function(event){
        clearInterval(interval);
        dragging = true;
        trackPointer(event,10);
        dragging = false;
    });
    
    $("#right").live('click', function(event){
        clearInterval(interval);
        $("#left, #right").css('display', 'none');
        $("#pause").css('display', 'inline');
        interval = window.setInterval(function(){
            dragging = true;
            trackPointer(event,speed);
            dragging = false;
        }, $("#amount").val());
    });
    
    $("#pause").live('click', function(){
        clearInterval(interval);
        interval = 0;
        $("#pause").css('display','none');
        $('#left').css('display','inline');
        $('#right').css('display','inline');
    })
    
    $("#index").mouseenter(function(){
        zoom = true;
    });
    $("#index").mouseleave(function(){
        zoom = false;
    });
    
    $(window).mousewheel(function(event, delta){
        if (zoom){
            if (delta == -1){
                scale = scale-0.1;
                img_width -= 10;
                img_height -= 10
            }
            else{ 
                scale = scale+0.1;
                img_width += 10;
                img_height += 10
            }
            if (scale <= 0.25) scale = 0.25;
            if (scale >= 3) scale = 3;
            $("#index img").css('transform', 'scale('+scale+')')
            $("#zoom").slider('value',scale);
            var matrix = matrix_obrob($(".current-image").css('transform'));
            run_zoom(matrix);
        }
    });
});

function matrix_obrob(matrix){
    if (matrix == 'none')
        return false;
    else{
        var arr = matrix.split(",");
        var scale = $.trim(arr[3]);
        if (scale == 1) return false; else return scale;
    }
}

function run_zoom(matrix){
     if (matrix){ 
         if (matrix > 1){
             var el = $(".current-image");
             $("#www").attr('id','');
             $(".current-image").attr('id', 'www');
             el = document.getElementById('www');
             console.log(el);
             var parent = $(el).parent().parent().parent();
             var leftEdge = $(parent).width() - img_width;
             var topEdge = $(parent).height() - img_height;
             //delete(dragObj);
             //dragObj = false;
             var dragObj = new dragObject(el, null, new Position(leftEdge, topEdge), new Position(Math.abs(leftEdge), Math.abs(topEdge)));
          }      
     }
}
    
function addSpinner () { 
    spinner = new CanvasLoader("spinner"); 
    spinner.setShape("spiral");
    spinner.setDiameter(90);
    spinner.setDensity(90);
    spinner.setRange(1);
    spinner.setSpeed(4);
    spinner.setColor("#333333");
    spinner.show(); 
    $("#spinner").fadeIn("slow");
};

function loadImage() {  
    var li = document.createElement("li");
    var imageName = "img/threesixty_" + (loadedImages + 1) + ".jpg"; 
    var image = $('<img>').attr('src', imageName).addClass("previous-image").appendTo(li);
    frames.push(image);
    $("#index_images").append(li);
    $(image).load(function() {
       imageLoaded();
    });
};
    
function imageLoaded() { 
    loadedImages++;
    $("#spinner span").text(Math.floor(loadedImages / totalFrames * 100) + "%");
    if (loadedImages == totalFrames) {
        frames[0].removeClass("previous-image").addClass("current-image");
        $("#spinner").fadeOut("slow", function(){
            spinner.hide();
            $("#start").remove();
            showThreesixty();
        });
        
    } 
    else{
        loadImage();
    }
};

function showThreesixty () { 
    $("#index_images").fadeIn("slow");
    img_width = $(".current-image").width();
    img_height = $(".current-image").height();
    ready = true;
    endFrame = -720; 
    refresh();
};

function render () {
    if(currentFrame !== endFrame){     
        var frameEasing = endFrame < currentFrame ? Math.floor((endFrame - currentFrame) * 0.1) : Math.ceil((endFrame - currentFrame) * 0.1);
        hidePreviousFrame();
        currentFrame += frameEasing; 
        showCurrentFrame();
    } 
    else{
        window.clearInterval(ticker);
        ticker = 0;
    }
};

function refresh(){ 
    if (ticker === 0){
        ticker = self.setInterval(render, Math.round(1000 / 60));
    }
};   

function hidePreviousFrame() {
    frames[getNormalizedCurrentFrame()].removeClass("current-image").addClass("previous-image");
};
	
function showCurrentFrame() { 
    frames[getNormalizedCurrentFrame()].removeClass("previous-image").addClass("current-image");
};
	
function getNormalizedCurrentFrame() {
    var c = -Math.ceil(currentFrame % totalFrames);
    if (c < 0) c += (totalFrames - 1);
    return c;
};

function getPointerEvent(event) {
    return event.originalEvent.targetTouches ? event.originalEvent.targetTouches[0] : event;
};

function trackPointer(event,flag) { 
    if (ready && dragging) { 
        pointerEndPosX = getPointerEvent(event).pageX; 
        if(monitorStartTime < new Date().getTime() - monitorInt) {
            pointerDistance = (flag) ? flag : pointerEndPosX - pointerStartPosX;
            //pointerDistance = pointerEndPosX - pointerStartPosX; 
            endFrame = currentFrame + Math.ceil((totalFrames - 1) * speedMultiplier * (pointerDistance / $("#index").width()));
            refresh();
            monitorStartTime = new Date().getTime();
            pointerStartPosX = getPointerEvent(event).pageX;
        }
    }
};

function create_buttons(){
    $("#left_long").button({
        text: false,
        icons: {
            primary: "ui-icon-arrowthick-1-w"
        }
    });
    $("#right_long").button({
        text: false,
        icons: {
            primary: "ui-icon-arrowthick-1-e"
        }
    });
    $("#left").button({
        text: false,
        icons: {
            primary: "ui-icon-triangle-1-w"
        }
    });
    $("#right").button({
        text: false,
        icons: {
            primary: "ui-icon-triangle-1-e"
        }
    });
    $("#pause").button({
        text: false,
        icons: {
            primary: "ui-icon-pause"
        }
    });
}     

function set_lang(){
    var loc = (navigator.language) ? navigator.language : navigator.userLanguage;
    var arr = loc.split('-');
    language = arr[0];
}

function set_localization(){
    locs = {
        "en":{
            "left_play": "Play left",
            "right_play": "Play right",
            "left_move": "Left move",
            "right_move": "Right move",
            'zoom': 'Zoom',
            'speed': 'Speed'
        },
	"ru":{
 	    "left_play": "Карусель влево",
            "right_play": "Карусель вправо",
            "left_move": "Одно движение влево",
            "right_move": "Одно движение вправо",
            'zoom': 'Масштаб',
            'speed': 'Скорость вращения'
 	}
    }
    
    set_titles();
}

function set_titles(){
    if (locs[language]){
        $("#left_long").attr('title', locs[language]['left_play']);
        $("#left").attr('title', locs[language]['left_move']);
        $("#right_long").attr('title', locs[language]['right_play']);
        $("#right").attr('title', locs[language]['right_move']);
        $("#zoom").attr('title', locs[language]['zoom']);
        $("#speed").attr('title', locs[language]['speed']);
    }
}








